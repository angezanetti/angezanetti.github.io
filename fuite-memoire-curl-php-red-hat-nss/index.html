<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Xavier">
<meta name="description"
    content="Depuis plusieurs mois je travaille pour une startup qui fait de la lutte contre la fraude. En deux mots, les clients nous envoient des flux XML et nous leur renvoyons note correspondant à l&amp;#8217;indice de confiance de la transaction.
Et, début Janvier nous avons intégré un GROS client. Du genre à faire pâlir les sysadmin. Cela nous à forcer à reconstruire une partie du code, à revoir l&amp;#8217;architecture de l&amp;#8217;application (qui est au passage devenue une application symfony2)." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://angezanetti.com/fuite-memoire-curl-php-red-hat-nss/" />


<title>
    
    Fuite mémoire avec curl et NSS sous RedHat :: Xavier Coiffard 
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://angezanetti.com/main.min.91687bbfc139d7ff1a244bb6d7324425f9c4f424eaaad242b478e3b3cf56396a.css">



<link rel="stylesheet" type="text/css" href="style.css">



<link rel="apple-touch-icon" sizes="180x180" href="https://angezanetti.com/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://angezanetti.com/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://angezanetti.com/favicon-16x16.png">
<link rel="manifest" href="https://angezanetti.com/site.webmanifest">
<link rel="mask-icon" href="https://angezanetti.com/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="https://angezanetti.com/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="Fuite mémoire avec curl et NSS sous RedHat">
<meta itemprop="description" content="Depuis plusieurs mois je travaille pour une startup qui fait de la lutte contre la fraude. En deux mots, les clients nous envoient des flux XML et nous leur renvoyons note correspondant à l&#8217;indice de confiance de la transaction.
Et, début Janvier nous avons intégré un GROS client. Du genre à faire pâlir les sysadmin. Cela nous à forcer à reconstruire une partie du code, à revoir l&#8217;architecture de l&#8217;application (qui est au passage devenue une application symfony2).">


<meta itemprop="datePublished" content="2015-04-27T12:13:51&#43;00:00" />
<meta itemprop="dateModified" content="2015-04-27T12:13:51&#43;00:00" />
<meta itemprop="wordCount" content="477">



<meta itemprop="keywords" content="Dev,Jobs,PHP,symfony," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://angezanetti.com"/>

<meta name="twitter:title" content="Fuite mémoire avec curl et NSS sous RedHat"/>
<meta name="twitter:description" content="Depuis plusieurs mois je travaille pour une startup qui fait de la lutte contre la fraude. En deux mots, les clients nous envoient des flux XML et nous leur renvoyons note correspondant à l&#8217;indice de confiance de la transaction.
Et, début Janvier nous avons intégré un GROS client. Du genre à faire pâlir les sysadmin. Cela nous à forcer à reconstruire une partie du code, à revoir l&#8217;architecture de l&#8217;application (qui est au passage devenue une application symfony2)."/>



<meta property="article:section" content="Uncategorized" />

<meta property="article:published_time" content="2015-04-27 12:13:51 &#43;0000 &#43;0000" />







    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://angezanetti.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">AngeZanetti.com</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://angezanetti.com/about/">About</a></li><li><a href="https://angezanetti.com/posts/">Blog</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://angezanetti.com/fuite-memoire-curl-php-red-hat-nss/">Fuite mémoire avec curl et NSS sous RedHat</a></h2>

            

            <div class="post-content">
                

<p>Depuis plusieurs mois je travaille pour une <a title="SellSecure" href="http://sellsecure.com/" target="_blank">startup</a> qui fait de la lutte contre la fraude. En deux mots, les clients nous envoient des flux XML et nous leur renvoyons note correspondant à l&#8217;indice de confiance de la transaction.</p>

<p>Et, début Janvier nous avons intégré un GROS client. Du genre à faire pâlir les sysadmin. Cela nous à forcer à reconstruire une partie du code, à revoir l&#8217;architecture de l&#8217;application (qui est au passage devenue une application symfony2).</p>

<p>Le problème à été de faire communiquer la nouvelle partie avec l&#8217;ancienne, et comme nous sommes en PHP, ben nous avons opté pour Curl.</p>

<p>Pour chaque score demandé nous avons donc un appel CURL du nouveau code vers l&#8217;ancien. Rien d&#8217;inquiétant, cela fait partie de l&#8217;habituel en PHP.</p>

<p>Sauf que là :</p>

<p>&nbsp;</p>

<blockquote class="twitter-tweet" lang="fr">
  <p>
    Se bat avec des fuites mémoires sur une application <a href="https://twitter.com/hashtag/Symfony?src=hash">#Symfony</a> <a href="https://twitter.com/hashtag/PHP?src=hash">#PHP</a> &#8230; <a href="http://t.co/lQpPp9uvXe">pic.twitter.com/lQpPp9uvXe</a>
  </p>
  
  <p>
    — Xavier Coiffard (@AngeZanetti) <a href="https://twitter.com/AngeZanetti/status/557458715214110721">20 Janvier 2015</a>
  </p>
</blockquote>

<p>Une belle grosse fuite mémoire, entre chaque restart Apache pas moyen de savoir où partait la mémoire. Nous avons d&#8217;abord accusé Symfony, l&#8217;<a title="Symfony Doctrine ORM charge" href="https://stackoverflow.com/questions/9699185/memory-leaks-symfony2-doctrine2-exceed-memory-limit" target="_blank">ORM à assez mauvaise réputation avec des dæmons</a> et Doctrine avoue ne pas être taillée pour absorber de la charge.</p>

<p>J&#8217;ai donc mis en place les fix nécessaires: forcer le garbage collector, désallouer la mémoire des objets inutilisés mais rien n&#8217;y faisait.</p>

<p>J&#8217;ai ensuite testé de lancer mes commandes en <em>&#8211;no-debug</em>, de virer les logs mais pas mieux, ma mémoire disparaissait toujours dans les méandres de mon système…</p>

<p>Toute ma RAM foutait le camp, de manière pernicieuse, petit à petit, Mo par Mo jusqu&#8217;à arriver à la limite du système, aux alentours du Go de libre &#8211; NB: le serveur n&#8217;avait pas l&#8217;air de souffrir par ailleurs, l&#8217;application ne ralentissait pas outre mesure…  </p>

<h2 id="nss-softoken">NSS Softoken</h2>

<p>Finalement c&#8217;est le sysadmin qui à trouvé l&#8217;origine, en farfouillant sur le web. Je lui avais parlé peu de temps avant d&#8217;une histoire de fuites mémoire dans le CURL, vaguement, j&#8217;avais rien pigé à l&#8217;article. Il est retombé dessus quelques jours plus tard, et BIM, révélation! Notre fuite mémoire était en fait dû à une faille système, une sombre histoire de NSS (<span class="blog-post-content ng-binding">Network Security Services</span>), qui est utilisée par <em>libcurl</em> et qui faisait du cache là où elle ne devrait pas.  C&#8217;est assez bas niveau, mais c&#8217;est un bug connu sur la version <span class="blog-post-content ng-binding">3.16.0</span>. C&#8217;est la version actuelle sur RedHat… Si vous voulez plus de détail je vous invite à lire cet article qui est la source de nos modifications : <a title="https://www.splyt.com/blog/2014-05-16-optimizing-aws-nss-softoken" href="https://www.splyt.com/blog/2014-05-16-optimizing-aws-nss-softoken" target="_blank"><a href="https://www.splyt.com/blog/2014-05-16-optimizing-aws-nss-softoken">https://www.splyt.com/blog/2014-05-16-optimizing-aws-nss-softoken</a></a></p>

<p>Le fix est assez simple, il suffit d&#8217;ajouter une ligne dans la conf&#8217; Apache:</p>

<blockquote>
<p># execute these commands as &#8216;root&#8217; echo &#8220;export NSS_SDB_USE_CACHE=YES&#8221; &gt;&gt; /etc/sysconfig/httpd service httpd restart</p>
</blockquote>

<p>Et voilà, comment retrouver le sourire et plusieurs Go de RAM ! </p>

<blockquote class="twitter-tweet" lang="fr">
  <p>
    Bonne nouvelle du début de semaine: c&#8217;est officiel on a trouvé la cause de la fuite mémoire ! <a href="https://twitter.com/hashtag/Curl?src=hash">#Curl</a> <a href="http://t.co/6pVqtGDO76">pic.twitter.com/6pVqtGDO76</a>
  </p>
  
  <p>
    — Xavier Coiffard (@AngeZanetti) <a href="https://twitter.com/AngeZanetti/status/564693290793308160">9 Février 2015</a>
  </p>
</blockquote>

            </div>
        </article>

        <hr />

        <div class="post-info">
  				<p>
  					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://angezanetti.com/tags/dev">Dev</a></span><span class="tag"><a href="https://angezanetti.com/tags/jobs">Jobs</a></span><span class="tag"><a href="https://angezanetti.com/tags/php">PHP</a></span><span class="tag"><a href="https://angezanetti.com/tags/symfony">symfony</a></span>
  				</p>
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
                <span><a href="https://angezanetti.com">Xavier Coiffard</a></span>
            
            <span>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</span>
            <span> <a href="https://angezanetti.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://angezanetti.com/bundle.min.cf7871ed49474a80ed457154d24e61f7881adbe0f9384951a74ac46b688a39a4dbfa68bc6d37baeb058186de354ead3487d4ee7f083ea4cba860c48600b694f3.js" integrity="sha512-z3hx7UlHSoDtRXFU0k5h94ga2&#43;D5OElRp0rEa2iKOaTb&#43;mi8bTe66wWBht41Tq00h9Tufwg&#43;pMuoYMSGALaU8w=="></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-13125864-1', 'auto');
        ga('send', 'pageview');
    </script>



    </body>
</html>
